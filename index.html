<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>AI Billboard Scanner ‚Äì SF Culture Overlay</title>
    <meta name="description" content="Web-based AR OCR app that detects AI buzzwords on billboards and overlays SF neighborhood culture stories. Works on mobile browsers." />
    <meta name="theme-color" content="#111" />
    <style>
      :root {
        --bg: #0b0b0b;
        --fg: #f3f3f3;
        --muted: #b7b7b7;
        --accent: #00e0b8;
        --danger: #ff5c5c;
        --card: #121212;
        --glass: rgba(10, 10, 10, 0.55);
        --glass-strong: rgba(10, 10, 10, 0.75);
        --border: rgba(255, 255, 255, 0.12);
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow: hidden;
      }

      /* Stage */
      #stage {
        position: fixed;
        inset: 0;
        display: grid;
        grid-template-rows: 1fr auto;
        background: #000;
      }

      video#camera {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #000;
        transform: scaleX(-1); /* mirror to feel natural when framing */
      }

      /* Overlay chrome */
      .overlay {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }

      .hud {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: env(safe-area-inset-bottom, 16px);
        display: flex;
        gap: 10px;
        padding: 10px 12px;
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: 16px;
        pointer-events: auto;
        backdrop-filter: saturate(1.1) blur(8px);
      }

      button.control {
        appearance: none;
        background: #1a1a1a;
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      button.control[data-active="true"] { outline: 2px solid var(--accent); }
      button.control:disabled { opacity: 0.5; cursor: not-allowed; }

      .scan-frame {
        position: absolute;
        left: 50%; top: 20%;
        width: min(82vw, 560px);
        height: min(40vh, 340px);
        transform: translateX(-50%);
        border: 2px dashed rgba(255,255,255,0.35);
        border-radius: 14px;
        background: radial-gradient(ellipse at center, rgba(0,0,0,0.12), rgba(0,0,0,0.06) 40%, rgba(0,0,0,0));
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.3);
        backdrop-filter: blur(2px);
      }
      .scan-dot {
        position: absolute;
        width: 10px; height: 10px; border-radius: 50%;
        background: var(--accent);
        right: 10px; top: 10px;
        box-shadow: 0 0 12px rgba(0, 224, 184, 0.8);
        animation: pulse 1.2s ease-in-out infinite;
      }
      @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.6);} 100%{transform:scale(1);} }

      .status {
        position: absolute;
        top: env(safe-area-inset-top, 12px);
        left: 50%; transform: translateX(-50%);
        padding: 8px 12px;
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 13px;
        pointer-events: none;
      }

      /* Result card */
      .result {
        position: absolute;
        left: 50%; bottom: calc(env(safe-area-inset-bottom, 16px) + 74px);
        transform: translateX(-50%);
        width: min(92vw, 720px);
        max-width: 720px;
        background: var(--glass-strong);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px 14px 12px 14px;
        box-shadow: 0 6px 30px rgba(0,0,0,0.45);
        backdrop-filter: blur(10px) saturate(1.2);
        display: none;
      }
      .result h3 { margin: 0 0 6px 0; font-size: 18px; }
      .result p { margin: 6px 0; color: var(--muted); line-height: 1.45; }
      .pill {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 6px 10px; border-radius: 999px;
        background: #191919; border: 1px solid var(--border);
        font-size: 12px; color: #ddd;
      }

      /* Start screen */
      #start {
        position: fixed; inset: 0; display: grid; place-items: center;
        background: radial-gradient(180px 180px at 50% 20%, rgba(0,224,184,0.18), rgba(0,0,0,0)) , var(--bg);
        padding: 22px;
      }
      .start-card {
        width: min(620px, 92vw);
        background: #101010;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        text-align: center;
      }
      .start-card h1 { margin: 8px 0 6px; font-size: 22px; }
      .start-card p { margin: 8px 0 0; color: var(--muted); }
      .cta {
        margin-top: 14px;
        width: 100%;
        background: linear-gradient(90deg, #00e0b8, #3be4ff);
        color: #081313; font-weight: 700; border: 0;
        border-radius: 12px; padding: 14px 16px; font-size: 16px;
        cursor: pointer;
      }
      .fine-print { margin-top: 8px; font-size: 12px; color: var(--muted); }

      /* Hidden canvas for OCR */
      #buffer { position: fixed; left: -99999px; top: -99999px; }

      a { color: #7be0ff; text-decoration: none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <div id="start">
      <div class="start-card">
        <div class="pill">üì∑ Camera + üî§ OCR + üìç Location</div>
        <h1>AI Billboard Scanner</h1>
        <p>Point at AI-lingo billboards ("ChatGPT", "machine learning", "AI-powered"). We detect the buzzwords and surface neighborhood stories instead.</p>
        <button id="startBtn" class="cta">Start camera</button>
        <div class="fine-print">On iOS/Safari, you must tap to grant camera and location. Works best outdoors and with steady framing.</div>
      </div>
    </div>

    <main id="stage" aria-live="polite" aria-busy="true" style="display:none">
      <video id="camera" playsinline autoplay muted></video>
      <canvas id="buffer"></canvas>
      <div class="overlay">
        <div class="status" id="status">Idle</div>
        <div class="scan-frame">
          <div class="scan-dot" aria-hidden="true"></div>
        </div>
      </div>

      <section id="result" class="result" role="dialog" aria-modal="false"></section>

      <div class="hud">
        <button id="toggleScan" class="control" aria-pressed="true">‚è∏Ô∏è Pause</button>
        <button id="torch" class="control" disabled>üî¶ Torch</button>
        <button id="flip" class="control">üîÅ Flip</button>
        <button id="snapshot" class="control">üì∏ Save</button>
      </div>
    </main>

    <!-- Tesseract.js (OCR) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script>
      (() => {
        const ui = {
          start: document.getElementById('start'),
          startBtn: document.getElementById('startBtn'),
          stage: document.getElementById('stage'),
          video: document.getElementById('camera'),
          canvas: document.getElementById('buffer'),
          status: document.getElementById('status'),
          result: document.getElementById('result'),
          toggleScan: document.getElementById('toggleScan'),
          torch: document.getElementById('torch'),
          flip: document.getElementById('flip'),
          snapshot: document.getElementById('snapshot'),
        };

        // Keywords to flag
        const aiKeywordPatterns = [
          /\b(?:chat\s*g[pt]t|chatg[pt]t|gpt)(?:[-\s]*\d+)?\b/i,
          /\b(ai|a\.i\.)\b/i,
          /\bartificial\s+intelligence\b/i,
          /\bmachine\s+learning\b/i,
          /\bdeep\s+learning\b/i,
          /\bneural\s+net(work|s)?\b/i,
          /\b(openai|bard|claude|copilot|gemini|llm|diffusion)\b/i,
          /\bgenerative\b/i,
          /\bai[-\s]?powered\b/i,
        ];

        // SF neighborhood centers and short stories
        const sfNeighborhoods = [
          {
            id: 'mission', name: 'Mission District', center: [37.7599, -122.4148],
            story: {
              title: "Carlos Santana's Mission roots",
              text: "Before global stages, Santana shaped sounds in the Mission‚Äîmelding Latin rock with the neighborhood's mural-streaked spirit.",
              link: "https://missionlocal.org/",
            },
          },
          {
            id: 'chinatown', name: 'Chinatown', center: [37.7941, -122.4078],
            story: {
              title: "Chinatown opera and activism",
              text: "From Cantonese opera to immigrant-led movements, Chinatown is a century-deep tapestry of language, food, and solidarity.",
              link: "https://www.chsa.org/",
            },
          },
          {
            id: 'fillmore', name: 'Fillmore / Western Addition', center: [37.7799, -122.4326],
            story: {
              title: "Harlem of the West",
              text: "The Fillmore once pulsed with jazz legends‚ÄîBillie Holiday, Dizzy Gillespie‚Äîcreating an unmatched West Coast sound.",
              link: "https://www.sfmuseum.org/",
            },
          },
          {
            id: 'bayview', name: 'Bayview‚ÄìHunters Point', center: [37.7309, -122.3827],
            story: {
              title: "Bayview's Black arts lineage",
              text: "Community studios and street festivals sustain Bayview's Black art traditions in the face of waves of redevelopment.",
              link: "https://bayviewopera.org/",
            },
          },
          {
            id: 'tenderloin', name: 'Tenderloin', center: [37.7831, -122.4167],
            story: {
              title: "Compton's Cafeteria uprising",
              text: "Years before Stonewall, trans and queer residents resisted police violence at Compton's Cafeteria right here in the Tenderloin.",
              link: "https://www.glbthistory.org/",
            },
          },
          {
            id: 'soma', name: 'SoMa', center: [37.7786, -122.4059],
            story: {
              title: "South of Market club culture",
              text: "DIY warehouses and underground clubs seeded electronic scenes that rewired Bay Area nightlife.",
              link: "https://grayarea.org/",
            },
          },
          {
            id: 'sunset', name: 'Sunset', center: [37.7486, -122.4940],
            story: {
              title: "Sunset surf and fog craft",
              text: "Ocean Beach surfers and makerspace tinkerers carve new rituals in the kingdom of fog.",
              link: "https://outsidelands.org/",
            },
          },
          {
            id: 'richmond', name: 'Richmond District', center: [37.7802, -122.4825],
            story: {
              title: "Richmond's diasporic kitchens",
              text: "From Burmese to Russian bakeries, the Richmond tells migration stories through soup dumplings and rye.",
              link: "https://richmondsf.org/",
            },
          },
        ];

        function haversineDistanceKm([lat1, lon1], [lat2, lon2]) {
          const toRad = d => (d * Math.PI) / 180;
          const R = 6371;
          const dLat = toRad(lat2 - lat1);
          const dLon = toRad(lon2 - lon1);
          const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          return R * c;
        }

        function nearestNeighborhood(position) {
          if (!position) return sfNeighborhoods[0];
          const pos = [position.coords.latitude, position.coords.longitude];
          let best = null; let min = Infinity;
          for (const n of sfNeighborhoods) {
            const d = haversineDistanceKm(pos, n.center);
            if (d < min) { min = d; best = n; }
          }
          return best;
        }

        let ocrWorker = null;
        let stream = null;
        let scanning = true;
        let usingBackCamera = true;
        let lastScanTs = 0;
        let lastText = '';
        let lastPosition = null;

        const SCAN_INTERVAL_MS = 1400;
        const TARGET_CANVAS_WIDTH = 720; // resized for OCR

        function setStatus(text) {
          ui.status.textContent = text;
        }

        function setResultCard({ title, bodyHtml }) {
          ui.result.innerHTML = `
            <div class="pill">üåÜ Local culture overlay</div>
            <h3>${title}</h3>
            ${bodyHtml}
          `;
          ui.result.style.display = 'block';
        }

        function hideResultCard() {
          ui.result.style.display = 'none';
          ui.result.innerHTML = '';
        }

        async function ensureWorker() {
          if (ocrWorker) return ocrWorker;
          setStatus('Loading OCR‚Ä¶');
          ocrWorker = await Tesseract.createWorker({
            workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/worker.min.js',
            langPath: 'https://tessdata.projectnaptha.com/4.0.0',
            corePath: 'https://cdn.jsdelivr.net/npm/tesseract.js-core@3.0.2/tesseract-core.wasm.js',
            logger: m => {
              if (m?.status) setStatus(`OCR: ${m.status}${m.progress ? ' ' + Math.round(m.progress*100) + '%' : ''}`);
            }
          });
          await ocrWorker.loadLanguage('eng');
          await ocrWorker.initialize('eng');
          setStatus('OCR ready');
          return ocrWorker;
        }

        async function startCamera() {
          const constraints = {
            audio: false,
            video: {
              facingMode: usingBackCamera ? { ideal: 'environment' } : { ideal: 'user' },
              width: { ideal: 1920 },
              height: { ideal: 1080 },
            }
          };
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          ui.video.srcObject = stream;
          await ui.video.play().catch(() => {});
          setStatus('Camera ready');

          // Torch availability
          try {
            const track = stream.getVideoTracks()[0];
            const caps = track.getCapabilities?.();
            if (caps && 'torch' in caps) {
              ui.torch.disabled = false;
            } else {
              ui.torch.disabled = true;
            }
          } catch (e) {
            ui.torch.disabled = true;
          }
        }

        function stopCamera() {
          if (stream) {
            for (const t of stream.getTracks()) t.stop();
            stream = null;
          }
        }

        async function setTorch(on) {
          if (!stream) return;
          const track = stream.getVideoTracks()[0];
          try {
            await track.applyConstraints({ advanced: [{ torch: !!on }] });
            ui.torch.dataset.active = on ? 'true' : 'false';
          } catch (e) {
            console.warn('Torch not supported', e);
          }
        }

        function extractCropRect(videoWidth, videoHeight) {
          // Focus central band where text likely appears on a billboard
          const cropWidth = Math.floor(videoWidth * 0.82);
          const cropHeight = Math.floor(videoHeight * 0.36);
          const x = Math.floor((videoWidth - cropWidth) / 2);
          const y = Math.floor(videoHeight * 0.20);
          return { x, y, width: cropWidth, height: cropHeight };
        }

        function downscaleAndCrop() {
          const vw = ui.video.videoWidth || 1280;
          const vh = ui.video.videoHeight || 720;
          if (!vw || !vh) return null;
          const scale = TARGET_CANVAS_WIDTH / vw;
          const ch = Math.floor(vh * scale);
          ui.canvas.width = TARGET_CANVAS_WIDTH;
          ui.canvas.height = ch;
          const ctx = ui.canvas.getContext('2d');
          ctx.drawImage(ui.video, 0, 0, TARGET_CANVAS_WIDTH, ch);
          const rect = extractCropRect(TARGET_CANVAS_WIDTH, ch);
          const crop = ctx.getImageData(rect.x, rect.y, rect.width, rect.height);

          // Optional contrast boost for legibility
          const data = crop.data;
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i], g = data[i+1], b = data[i+2];
            let y = 0.2126*r + 0.7152*g + 0.0722*b; // luminance
            y = Math.min(255, Math.max(0, (y - 128) * 1.15 + 128));
            data[i] = data[i+1] = data[i+2] = y;
          }
          ctx.putImageData(crop, rect.x, rect.y);
          return { rect, width: TARGET_CANVAS_WIDTH, height: ch };
        }

        function containsAIKeyword(text) {
          if (!text) return false;
          for (const rx of aiKeywordPatterns) {
            if (rx.test(text)) return true;
          }
          return false;
        }

        function renderNeighborhoodCard(textFound) {
          const n = nearestNeighborhood(lastPosition);
          const title = `In ${n.name}: ${n.story.title}`;
          const bodyHtml = `
            <p>${n.story.text}</p>
            <p class="fine-print">Detected keyword: <span class="pill">${textFound}</span></p>
            <p><a href="${n.story.link}" target="_blank" rel="noopener">Learn more ‚Üí</a></p>
          `;
          setResultCard({ title, bodyHtml });
        }

        async function scanLoop() {
          if (!scanning || !stream) return;
          const now = performance.now();
          if (now - lastScanTs < SCAN_INTERVAL_MS) return;
          lastScanTs = now;

          try {
            const worker = await ensureWorker();
            const dims = downscaleAndCrop();
            if (!dims) return;
            const { data: { text } } = await worker.recognize(ui.canvas);
            const normalized = (text || '').replace(/\s+/g, ' ').trim();
            lastText = normalized;
            setStatus(normalized ? `Text detected (${normalized.slice(0, 40)}${normalized.length > 40 ? '‚Ä¶' : ''})` : 'Scanning‚Ä¶');
            const hit = aiKeywordPatterns.find(rx => rx.test(normalized));
            if (hit) {
              scanning = false;
              ui.toggleScan.textContent = '‚ñ∂Ô∏è Resume';
              renderNeighborhoodCard(hit.source?.replace(/\\b/g, '') || 'AI');
              setStatus('AI keyword found');
            }
          } catch (err) {
            console.error(err);
            setStatus('Scan error (will retry)');
          }
        }

        // Animation frame scheduler with throttling
        function onFrame() {
          if (scanning) scanLoop();
          requestAnimationFrame(onFrame);
        }

        // Geolocation
        function requestLocation() {
          if (!('geolocation' in navigator)) return;
          navigator.geolocation.getCurrentPosition(
            pos => { lastPosition = pos; },
            _err => { /* ignore, we fallback */ },
            { enableHighAccuracy: true, maximumAge: 30_000, timeout: 7_000 }
          );
          // Also watch to update while moving
          try {
            navigator.geolocation.watchPosition(pos => { lastPosition = pos; });
          } catch {}
        }

        // Controls
        ui.toggleScan.addEventListener('click', () => {
          scanning = !scanning;
          ui.toggleScan.textContent = scanning ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Resume';
          if (scanning) hideResultCard();
        });

        ui.torch.addEventListener('click', async () => {
          const active = ui.torch.dataset.active === 'true';
          await setTorch(!active);
        });

        ui.flip.addEventListener('click', async () => {
          usingBackCamera = !usingBackCamera;
          stopCamera();
          try { await startCamera(); } catch (e) { setStatus('Flip failed'); }
        });

        ui.snapshot.addEventListener('click', () => {
          const canvas = document.createElement('canvas');
          const vw = ui.video.videoWidth; const vh = ui.video.videoHeight;
          if (!vw || !vh) return;
          canvas.width = vw; canvas.height = vh;
          const ctx = canvas.getContext('2d');
          ctx.translate(vw, 0); // un-mirror
          ctx.scale(-1, 1);
          ctx.drawImage(ui.video, 0, 0, vw, vh);
          canvas.toBlob(blob => {
            if (!blob) return;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'scan.jpg'; a.click();
            URL.revokeObjectURL(url);
          }, 'image/jpeg', 0.9);
        });

        // Start button
        ui.startBtn.addEventListener('click', async () => {
          try {
            requestLocation();
            await startCamera();
            await ensureWorker();
            ui.start.style.display = 'none';
            ui.stage.style.display = 'grid';
            setStatus('Scanning‚Ä¶');
          } catch (e) {
            console.error(e);
            alert('Camera permission is required. Please allow camera access.');
          }
        });

        // Lifecycle
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            stopCamera();
          } else {
            startCamera().catch(() => {});
          }
        });

        window.addEventListener('beforeunload', () => {
          stopCamera();
          if (ocrWorker) { ocrWorker.terminate?.(); ocrWorker = null; }
        });

        // Start RAF
        requestAnimationFrame(onFrame);
      })();
    </script>
  </body>
  </html>

